<!DOCTYPE html>
<html lang="en">

<head>
<title>Globe - in a universe of imagination</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<style>
html, body { width: 100%; height: 100%; margin: 0px; background-color: black; overflow: hidden; }

/* * { scroll-behavior: smooth; } */
*::-webkit-scrollbar { height: 6px; width: 6px; }
*::-webkit-scrollbar-thumb { background: white;border-radius: 3px; }

div.layout-bottom {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  position: fixed;
  left: 0px;
  right: 0px;
  bottom: 0px;
  transition: bottom 0.4s ease-in-out;
  overflow: hidden;
}
div.layout-show-bottom {
  display: flex;
  align-items: center;
  width: 64px;
  height: 64px;
  opacity: 1;
  transition: opacity 0.4s ease-in-out;
}
button.button-show-typing {
  width: 64px;
  height: 40px;
  border-radius: 8px;
  border: 1px solid black;
  outline: none;
  margin: 0px;
  padding: 0px;
  background-color: #ffc800;
  color: white;
  font-weight: bold;
  text-shadow: 0px 0px 2px black;
  box-shadow: inset 0px 0px 4px 2px white;
  cursor: pointer;
  user-select: none;
}
button.button-show-typing:hover { background-color: #00c8ff; }
button.button-show-typing:active { background-color: #c8ff00; }
div.layout-typing {
  display: flex;
  justify-content: center;
  width: 600px;
  max-width: 100%;
  height: 40px;
  background-color: black;
  border: 1px solid black;
  border-radius: 8px 8px 0px 0px;
  overflow: hidden;
}
button.button-submit-typing {
  width: 80px;
  border: none;
  outline: none;
  margin: 0px;
  padding: 0px;
  border-left: 1px solid black;
  background-color: #ffc800;
  color: white;
  font-weight: bold;
  text-shadow: 0px 0px 2px black;
  box-shadow: inset 0px 0px 4px 2px white;
  cursor: pointer;
  user-select: none;
}
button.button-submit-typing:hover { background-color: #00c8ff; }
button.button-submit-typing:active { background-color: #c8ff00; }

body[data-mode=moving] .layout-typing { user-select: none; pointer-events: none; }
body[data-mode=moving] .layout-bottom { bottom: -120px; }

body[data-mode=typing] .layout-show-bottom { opacity: 0; }
</style>
</head>

<body data-mode="typing">

<div class="layout-bottom">
  <div class="layout-show-bottom">
    <button class="button-show-typing">메시지</button>
  </div>
  <div class="layout-message-list" style="width: 600px; max-width: 100%; background: rgba(0, 0, 0, 0.4); border-radius: 8px; margin-bottom: 4px;">
    <ul class="list-message" style="color: white; list-style: none; height: 52px; overflow: auto; margin: 8px 8px 4px 8px; padding: 4px; font-size: 14px; user-select: none; pointer-events: none;"></ul>
  </div>
  <div class="layout-typing">
    <input class="input-typing" type="text" style="display: block; position: relative; padding: 12px; width: 100%;  border: none; outline: none; background-color: white; color: black; font-size: 14px; font-family: sans-serif;">
    <button class="button-submit-typing">보내기</button>
  </div>
</div>

<!-- Import maps polyfill -->
<!-- Remove this when import maps will be widely supported -->
<script async src=" https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js">
</script>

<script type="importmap">
{
  "imports": {
    "three": "./libs/threejs/build/three.module.js",
    "three/addons/": "./libs/threejs/jsm/",
    "globe": "./src/index.js"
  }
}
</script>


<script type="module">

  import * as THREE from 'three';
  import * as GLOBE from 'globe';

  import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
  import { OutlineEffect } from 'three/addons/effects/OutlineEffect.js';

  THREE.Cache.enabled = true;

  let container;

  let renderer, effect;
  let camera, cameraTarget, scene;

  let root;

  let keyStatus = {};

  init();
  animate();

  function init() {

    container = document.createElement('div');
    document.body.appendChild(container);

    // CAMERA
    camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 200, 3000);
    camera.position.set(0, 800, -50);
    // camera.position.set(0, 0, 1000);

    cameraTarget = new THREE.Vector3(0, 0, 0);
    // cameraTarget = new THREE.Vector3(0, 0, 1);

    // SCENE
    scene = new GLOBE.GlobeOrbisScene();
    root = new GLOBE.GlobeGrassOrbisGroup();

    scene.add(root);

    // RENDERER
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    container.appendChild(renderer.domElement);
    effect = new OutlineEffect(renderer)

    // EVENTS
    container.style.touchAction = 'none';
    window.addEventListener('keydown', onKeyDown);
    window.addEventListener('keyup', onKeyUp);

    window.addEventListener('resize', onWindowResize);
  }

  function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();

    // renderer.setSize(window.innerWidth, window.innerHeight);
    effect.setSize( window.innerWidth, window.innerHeight );
  }

  function animate() {
    compute();
    render();

    requestAnimationFrame(animate);
  }

  function onKeyDown(event) {
    const keyCode = event.which;
    if (keyCode == 37) keyStatus.left = { pressed: true, ts: Date.now() };
    if (keyCode == 39) keyStatus.right = { pressed: true, ts: Date.now() };
    if (keyCode == 38) keyStatus.up = { pressed: true, ts: Date.now() };
    if (keyCode == 40) keyStatus.down = { pressed: true, ts: Date.now() };
    if (keyCode == 32) {
      root.randomActionPlayer();
      keyStatus.left = null;
      keyStatus.right = null;
      keyStatus.up = null;
      keyStatus.down = null;
      return;
    }
    if (keyStatus.left != null || keyStatus.right != null || keyStatus.up != null || keyStatus.down != null) {
      root.walkPlayer();
    }
  }

  function onKeyUp(event) {
    const keyCode = event.which;
    if (keyCode == 37) keyStatus.left = null;
    if (keyCode == 39) keyStatus.right = null;
    if (keyCode == 38) keyStatus.up = null;
    if (keyCode == 40) keyStatus.down = null;
    if (keyCode == 32) return;
    if (keyStatus.left == null && keyStatus.right == null && keyStatus.up == null && keyStatus.down == null) {
      root.idlePlayer();
    }
  }

  function compute() {
    // Player moving
    let movingDirection = 0, turningDirection = 0;
    if (keyStatus.left) turningDirection = -1;
    else if (keyStatus.right) turningDirection = 1;
    if (keyStatus.up) movingDirection = 1;
    else if (keyStatus.down) movingDirection = -1;

    root.movePlayer(movingDirection, turningDirection);

    root.updateAnimation();
  }

  function render() {

    camera.lookAt(cameraTarget);

    // renderer.clear();
    // renderer.render(scene, camera);

    effect.clear();
    effect.render(scene, camera);
  }

</script>

<script type="module">
const GlobeApp = function() {
  let mode;

  // Elements
  const showTypingButton = document.querySelector('.button-show-typing');
  const messageList = document.querySelector('.list-message');
  const typingBox = document.querySelector('.input-typing');
  const submitTypingButton = document.querySelector('.button-submit-typing');

  this.setTypingMode = function() {
    document.body.setAttribute('data-mode', mode = 'typing');
    typingBox.disabled = false;
    typingBox.focus();
  };
  
  this.setMovingMode = function() {
    document.body.setAttribute('data-mode', mode = 'moving');
    typingBox.disabled = true;
    typingBox.blur();
  };

  this.submitTyping = function() {
    const typingContent = typingBox.value.trim();
    if (!typingContent) {
      typingBox.value = null;
      return false;
    }

    typingBox.value = null;

    // TODO
    console.log(typingContent);
    
    return true;
  }

  // Initialize events
  showTypingButton.addEventListener('click', () => {
    this.setTypingMode();
  });

  typingBox.addEventListener('keydown', (event) => {
    if (mode != "typing") return;
    
    if (event.which == 13) {
      const success = this.submitTyping();
      if (success == false) {
        setTimeout(() => {
          this.setMovingMode();
        });
      }
    }
  });

  submitTypingButton.addEventListener('click', () => {
    if (mode != "typing") return;

    this.submitTyping();
  });
  
  window.addEventListener('keydown', (event) => {
    if (event.which == 13) {
      this.setTypingMode();
    } else if (event.which == 27) {
      this.setMovingMode();
    }
  });

  // Test
  setInterval(() => {
    const item = document.createElement('li');
    item.textContent = "시스템 - 안녕하세요? " + new Date().toISOString();
    messageList.appendChild(item);
    messageList.scrollBy(0, 1000000);
  }, 1000);

  // Initialize status
  this.setTypingMode();
};

window.onload = function() {
  const app = new GlobeApp();
};

</script>

</body>

</html>

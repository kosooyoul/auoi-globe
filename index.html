<!DOCTYPE html>
<html lang="en">

<head>
  <title>Globe - in a universe of imagination</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
  <style>
    html,
    body {
      margin: 0px;
      background-color: black;
      overflow: hidden;
    }
  </style>
</head>

<body>

<!-- Import maps polyfill -->
<!-- Remove this when import maps will be widely supported -->
<script async src=" https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js">
</script>

<script type="importmap">
{
  "imports": {
    "three": "./libs/threejs/build/three.module.js",
    "three/addons/": "./libs/threejs/jsm/",
    "globe": "./src/index.js"
  }
}
</script>


<script type="module">

  import * as THREE from 'three';
  import * as GLOBE from 'globe';

  import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
  import { OutlineEffect } from 'three/addons/effects/OutlineEffect.js';

  THREE.Cache.enabled = true;

  let container;

  let renderer, effect;
  let camera, cameraTarget, scene;

  let root, grassOrbisGroup;
  let motherRockOrbisPivotGroup, motherRockOrbisGroup;
  let satelliteRockOrbisPivotGroup, satelliteRockOrbisGroup;
  
  let playerGroup, playerNode;
  let motherNpc1Group, motherNpc1Node;
  let motherNpc2Group, motherNpc2Node;
  let satelliteNpcGroup, satelliteNpcNode;

  let previousQuaternion = new THREE.Quaternion();
  let targetQuaternion = new THREE.Quaternion();
  let slerpedQuaternion = new THREE.Quaternion();
  let slerpTime = 0;

  let keyStatus = {};

  init();
  animate();

  function init() {

    container = document.createElement('div');
    document.body.appendChild(container);

    // CAMERA
    camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 400, 3000);
    camera.position.set(0, 800, -50);
    // camera.position.set(0, 0, 1000);

    cameraTarget = new THREE.Vector3(0, 0, 0);
    // cameraTarget = new THREE.Vector3(0, 0, 1);

    // SCENE
    scene = new GLOBE.GlobeOrbisScene();
    root = new GLOBE.GlobeGrassOrbisGroup();

    scene.add(root);

    // RENDERER
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    container.appendChild(renderer.domElement);
    effect = new OutlineEffect(renderer)

    // EVENTS
    container.style.touchAction = 'none';
    window.addEventListener('keydown', onKeyDown);
    window.addEventListener('keyup', onKeyUp);

    window.addEventListener('resize', onWindowResize);
  }

  function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();

    // renderer.setSize(window.innerWidth, window.innerHeight);
    effect.setSize( window.innerWidth, window.innerHeight );
  }

  function animate() {
    compute();
    render();

    requestAnimationFrame(animate);
  }

  function onKeyDown(event) {
    const keyCode = event.which;
    if (keyCode == 37) {
      keyStatus.left = { pressed: true, ts: Date.now() };
      root.walkPlayer();
    }
    if (keyCode == 39) {
      keyStatus.right = { pressed: true, ts: Date.now() };
      root.walkPlayer();
    }
    if (keyCode == 38) {
      keyStatus.up = { pressed: true, ts: Date.now() };
      root.walkPlayer();
    }
    if (keyCode == 40) {
      keyStatus.down = { pressed: true, ts: Date.now() };
      root.walkPlayer();
    }
    if (keyCode == 13) {
      root.randomActionPlayer();
      keyStatus.left = null;
      keyStatus.right = null;
      keyStatus.up = null;
      keyStatus.down = null;
    }
    if (keyCode == 32) {
      root.jumpPlayer();
    }
  }

  function onKeyUp(event) {
    const keyCode = event.which;
    if (keyCode == 37) keyStatus.left = null;
    if (keyCode == 39) keyStatus.right = null;
    if (keyCode == 38) keyStatus.up = null;
    if (keyCode == 40) keyStatus.down = null;
    if (keyCode == 13) return;
    if (keyCode == 32) return;
    if (keyStatus.left == null && keyStatus.right == null && keyStatus.up == null && keyStatus.down == null) {
      root.idlePlayer();
    }
  }

  function compute() {
    // Player moving
    let movingDirection = 0, turningDirection = 0;
    if (keyStatus.left) turningDirection = -1;
    else if (keyStatus.right) turningDirection = 1;
    if (keyStatus.up) movingDirection = 1;
    else if (keyStatus.down) movingDirection = -1;

    root.movePlayer(movingDirection, turningDirection);

    root.updateAnimation();
  }

  function render() {

    camera.lookAt(cameraTarget);

    // renderer.clear();
    // renderer.render(scene, camera);

    effect.clear();
    effect.render(scene, camera);
  }

</script>

</body>

</html>

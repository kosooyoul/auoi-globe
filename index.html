<!DOCTYPE html>
<html lang="en">

<head>
<title>Globe - in a universe of imagination</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<style>
html, body { width: 100%; height: 100%; margin: 0px; background-color: black; overflow: hidden; }

/* * { scroll-behavior: smooth; } */
*::-webkit-scrollbar { height: 6px; width: 6px; }
*::-webkit-scrollbar-thumb { background: white;border-radius: 3px; }

div.layout-bottom {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  position: fixed;
  left: 0px;
  right: 0px;
  bottom: 0px;
  transition: bottom 0.4s ease-in-out;
  overflow: hidden;
}
div.layout-show-bottom {
  display: flex;
  align-items: center;
  width: 64px;
  height: 64px;
  opacity: 1;
  transition: opacity 0.4s ease-in-out;
}
button.button-show-typing {
  width: 64px;
  height: 40px;
  border-radius: 8px;
  border: 1px solid black;
  outline: none;
  margin: 0px;
  padding: 0px;
  background-color: #ffc800;
  color: white;
  font-weight: bold;
  text-shadow: 0px 0px 2px black;
  box-shadow: inset 0px 0px 4px 2px white;
  cursor: pointer;
  user-select: none;
}
button.button-show-typing:hover { background-color: #00c8ff; }
button.button-show-typing:active { background-color: #c8ff00; }
div.layout-typing {
  display: flex;
  justify-content: center;
  width: 600px;
  max-width: 100%;
  height: 40px;
  background-color: black;
  border: 1px solid black;
  border-radius: 8px 8px 0px 0px;
  overflow: hidden;
}
button.button-submit-typing {
  width: 80px;
  border: none;
  outline: none;
  margin: 0px;
  padding: 0px;
  border-left: 1px solid black;
  background-color: #ffc800;
  color: white;
  font-weight: bold;
  text-shadow: 0px 0px 2px black;
  box-shadow: inset 0px 0px 4px 2px white;
  cursor: pointer;
  user-select: none;
}
button.button-submit-typing:hover { background-color: #00c8ff; }
button.button-submit-typing:active { background-color: #c8ff00; }

body[data-mode=moving] .layout-typing { user-select: none; pointer-events: none; }
body[data-mode=moving] .layout-bottom { bottom: -120px; }

body[data-mode=typing] .layout-show-bottom { opacity: 0; }
</style>
</head>

<body data-mode="typing">

<div class="layout-bottom">
  <div class="layout-show-bottom">
    <button class="button-show-typing">메시지</button>
  </div>
  <div class="layout-message-list" style="width: 600px; max-width: 100%; background: rgba(0, 0, 0, 0.4); border-radius: 8px; margin-bottom: 4px;">
    <ul class="list-message" style="color: white; list-style: none; height: 52px; overflow: auto; margin: 8px 8px 4px 8px; padding: 4px; font-size: 14px; user-select: none;"></ul>
  </div>
  <div class="layout-typing">
    <input class="input-typing" type="text" style="display: block; position: relative; padding: 12px; width: 100%;  border: none; outline: none; background-color: white; color: black; font-size: 14px; font-family: sans-serif;">
    <button class="button-submit-typing">보내기</button>
  </div>
</div>

<div>
  <div class="test" style="position: absolute; width: 92px; height: 24px; font-size: 14px; font-family: sans-serif; border-radius: 8px; margin-left: -46px; margin-top: -84px; line-height: 24px; text-align: center; color: black; background-color: rgba(255, 255, 255, 0.4); vertical-align: middle;">Anonymous</div>
</div>

<!-- Import maps polyfill -->
<!-- Remove this when import maps will be widely supported -->
<script async src=" https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
<script type="text/javascript" src="./libs/socket.io/socket.io-4.5.4.min.js"></script>

<script type="importmap">
{
  "imports": {
    "three": "./libs/threejs/build/three.module.js",
    "three/addons/": "./libs/threejs/jsm/",
    "globe": "./src/index.js"
  }
}
</script>


<script type="module">
import * as THREE from 'three';
import * as GLOBE from 'globe';

import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
import { OutlineEffect } from 'three/addons/effects/OutlineEffect.js';

THREE.Cache.enabled = true;

let container;
let testElement;

let renderer, effect;
let scene;

let keyStatus = {};

init();
animate();

function init() {

  container = document.createElement('div');
  document.body.appendChild(container);
  
  testElement = document.querySelector('.test');

  // SCENE
  scene = new GLOBE.GlobeOrbisScene();
  scene.setOnPlayerStatusListener(({ quaternion, action }) => window.postMessage({
    'type': 'player-status',
    'quaternion': {
      x: quaternion.x,
      y: quaternion.y,
      z: quaternion.z,
      w: quaternion.w,
    },
    'action': action,
  }));

  // RENDERER
  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.setSize(window.innerWidth, window.innerHeight);
  container.appendChild(renderer.domElement);
  effect = new OutlineEffect(renderer)

  // EVENTS
  container.style.touchAction = 'none';
  window.addEventListener('keydown', onKeyDown);
  window.addEventListener('keyup', onKeyUp);

  window.addEventListener('resize', onWindowResize);

  window.addEventListener('message', (event) => {
    if (event.data.type == 'people-status') {
      scene.updatePeopleStatus(event.data.id, event.data);
    }
  });
}

function onWindowResize() {
  scene.setAspectRatio(window.innerWidth / window.innerHeight);

  // renderer.setSize(window.innerWidth, window.innerHeight);
  effect.setSize( window.innerWidth, window.innerHeight );
}

function animate() {
  compute();
  render();

  requestAnimationFrame(animate);
}

function onKeyDown(event) {
  const keyCode = event.which;
  if (keyCode == 37) keyStatus.left = { pressed: true, ts: Date.now() };
  if (keyCode == 39) keyStatus.right = { pressed: true, ts: Date.now() };
  if (keyCode == 38) keyStatus.up = { pressed: true, ts: Date.now() };
  if (keyCode == 40) keyStatus.down = { pressed: true, ts: Date.now() };
  if (keyCode == 32) {
    scene.randomActionPlayer();
    keyStatus.left = null;
    keyStatus.right = null;
    keyStatus.up = null;
    keyStatus.down = null;
    return;
  }
  if (keyStatus.left != null || keyStatus.right != null || keyStatus.up != null || keyStatus.down != null) {
    scene.walkPlayer();
  }
}

function onKeyUp(event) {
  const keyCode = event.which;
  if (keyCode == 37) keyStatus.left = null;
  if (keyCode == 39) keyStatus.right = null;
  if (keyCode == 38) keyStatus.up = null;
  if (keyCode == 40) keyStatus.down = null;
  if (keyCode == 32) return;
  if (keyStatus.left == null && keyStatus.right == null && keyStatus.up == null && keyStatus.down == null) {
    scene.idlePlayer();
  }
}

function compute() {
  // Player moving
  let movingDirection = 0, turningDirection = 0;
  if (keyStatus.left) turningDirection = -1;
  else if (keyStatus.right) turningDirection = 1;
  if (keyStatus.up) movingDirection = 1;
  else if (keyStatus.down) movingDirection = -1;

  scene.movePlayer(movingDirection, turningDirection);

  scene.updateAnimation();
  
  const v = new THREE.Vector3();
  scene.playerNode.getWorldPosition(v);
  v.project(scene.camera);
  const x = (v.x + 1) * window.innerWidth * 0.5;
  const y = (1 - v.y) * window.innerHeight * 0.5;
  testElement.style.left = x + 'px';
  testElement.style.top = y + 'px';
}

function render() {
  // renderer.clear();
  // renderer.render(scene, scene.camera);

  effect.clear();
  effect.render(scene, scene.camera);
}
</script>

<script type="module">
const GlobeApp = function() {
  let mode;

  // Elements
  const showTypingButton = document.querySelector('.button-show-typing');
  const messageList = document.querySelector('.list-message');
  const typingBox = document.querySelector('.input-typing');
  const submitTypingButton = document.querySelector('.button-submit-typing');

  this.setTypingMode = function() {
    document.body.setAttribute('data-mode', mode = 'typing');
    typingBox.disabled = false;
    typingBox.focus();
  };
  
  this.setMovingMode = function() {
    document.body.setAttribute('data-mode', mode = 'moving');
    typingBox.disabled = true;
    typingBox.blur();
  };

  this.submitTyping = function() {
    const typingContent = typingBox.value.trim();
    if (!typingContent) {
      typingBox.value = null;
      return false;
    }

    typingBox.value = null;

    // TODO
    console.log(typingContent);
    window.postMessage({
      'type': 'player-message',
      'message': typingContent,
    });
    
    return true;
  }

  // Initialize events
  showTypingButton.addEventListener('click', () => {
    this.setTypingMode();
  });

  typingBox.addEventListener('keydown', (event) => {
    if (mode != "typing") return;
    
    if (event.which == 13) {
      const success = this.submitTyping();
      if (success == false) {
        setTimeout(() => {
          this.setMovingMode();
        });
      }
    }
  });

  submitTypingButton.addEventListener('click', () => {
    if (mode != "typing") return;

    this.submitTyping();
  });
  
  window.addEventListener('keydown', (event) => {
    if (event.which == 13) {
      this.setTypingMode();
    } else if (event.which == 27) {
      this.setMovingMode();
    }
  });

  window.addEventListener('message', (event) => {
    if (event.data.type == 'people-message') {
      const item = document.createElement('li');
      item.textContent = `[${event.data.id}] ${event.data.message}`;
      messageList.appendChild(item);
      messageList.scrollBy(0, 1000000);
    }
  });

  // Initialize status
  this.setTypingMode();
};

const GlobeSocket = function() {
  const socket = new io('https://subscribe.auoi.net');

  const onlineObjects = {};
  let socketId = null;

  const onReady = (data) => {
    socketId = data.id;
    console.log('socketId', data);

    for (const id in data.objects) {
      const object = data.objects[id];
      onlineObjects[id] = { id: object.id, quaternion: object.q, action: object.a, message: null };
    }

    // socket.emit('enter', { q: object.q, a: object.a  });x
  };

  const onEnter = (data) => {
    if (data.id == socketId) return;

    onlineObjects[data.id] = {
      id: data.id,
      quaternion: data.q,
      action: data.a,
      message: null,
    };
  };

  const onMove = (data) => {
    if (data.id == socketId) return;

    window.postMessage({ type: 'people-status', id: data.id, quaternion: data.q, action: data.a });

    // if (onlineObjects[data.id] == null) {
    //   onlineObjects[data.id] = {
    //     id: data.id,
    //     quaternion: data.q,
    //     action: data.a,
    //     message: null,
    //   };
    // } else {
    //   onlineObjects[data.id].quaternion = data.q;
    //   onlineObjects[data.id].action = data.a;
    //   onlineObjects[data.id].message = data.m;
    // }
  };

  const onLeave = (data) => {
    if (data.id == socketId) return;

    delete onlineObjects[data.id];
  };

  const onMessage = (data) => {
    if (data.id == socketId) return;

    window.postMessage({ type: 'people-message', id: data.id, message: data.message });

    // if (onlineObjects[data.id] != null) {
    //   onlineObjects[data.id].message = data.m;
    //   onlineObjects[data.id].messageExpiresIn = Date.now() + 1000 * 5;
    // }
  };

  this.subscribe = function() {
    socket.on('ready', onReady);
    socket.on('enter', onEnter);
    socket.on('move', onMove);
    socket.on('leave', onLeave);
    socket.on('message', onMessage);
  };

  this.sendMessage = function(message) {
    socket.emit('message', { message });
    window.postMessage({ type: 'people-message', id: socketId, message: message });
  };

  this.postStatus = function({ quaternion, action }) {
		socket.emit('move', {
			q: quaternion,
			a: action,
		});
  };

  let lastPlayerStatusPostedAt;
  window.addEventListener('message', (event) => {
    if (event.data.type == 'player-status') {
      if (Date.now() - lastPlayerStatusPostedAt < 1000) return;

      this.postStatus({
        quaternion: event.data.quaternion,
        action: event.data.action,
      });
      lastPlayerStatusPostedAt = Date.now();
    } else if (event.data.type == 'player-message') {
      this.sendMessage(event.data.message);
    }
  });
};

window.onload = function() {
  const app = new GlobeApp();
  const socket = new GlobeSocket();
  socket.subscribe();
};
</script>

</body>

</html>
